#!/usr/bin/env python
'''
class scanner to be implemented in vuln_scanner
'''
import re
import requests
import urllib.parse
from bs4 import BeautifulSoup
from termcolor import colored




class Scanner:
	def __init__(self,url,refused_links):
		self.session = requests.Session()
		self.target_url = url
		self.list_links = []
		self.refused_links = refused_links


#build a site map: crawler 

#finds the whole links in a page _basically called by the crawl function_
	def extract_links(self,url):
		response = str(self.session.get(url).content)
		return re.findall('(?:href=")(.*?)"',response)	

# crawl does pasre all the possible links from a given start_url && fills the variable list_links with found links 
	def crawl(self,url= None):
		if url == "None":
			url=self.target_url  
		links = self.extract_links(url) 

		for link in links:
			link = urllib.parse.urljoin(url,link)
			if "#" in link:
				link = link.split("#")[0] 
			if self.target_url in link and link not in self.list_links and link not in self.refused_links:
				self.list_links.append(link)
				#print(link)
				self.crawl(link)

# getting all the forms of a webpage_url_	&& returns the forms
	def extract_html(self,get_from_this_url):
		content = self.session.get(get_from_this_url).content
		parsed_html = BeautifulSoup(content,features="lxml")
		# return all the forms 
		return parsed_html.findAll("form")	

# returns a get/post request to a session with submitted form
	def submit_form(self,form,value,url):

		action = form.get("action")	 

		post_url = urllib.parse.urljoin(url,action)
		#print(post_url)
		post_data = {}

		method = form.get("method")

		input_list = form.findAll("input")
		#print(input_list)
		
		for input_tag in input_list:
			input_name =input_tag.get("name")
			input_type =input_tag.get("type")
			input_value=input_tag.get("value")
			if input_type == "submit":
				input_value="submit"
			if input_type == "text":
				input_value = value
			post_data[input_name]=input_value
			#print(post_data)
		if method == "post":
			return self.session.post(post_url,data = post_data)
		return self.session.get(post_url,params = post_data)		 


#returns True when xss test is performed in a form, else None 
	def test_xss_form(self,form,url):
		xss_test_script = "<sCript>Alert('tested')</scrIpt>"
		response = self.submit_form(form,xss_test_script,url)
		return xss_test_script in  response.content.decode()



#returns True when xss test is performed in a url, else None
	def test_xss_link(self,url):
		xss_test_script = "<sCript>Alert('tested')</scrIpt>"
		url = url.replace("=","="+xss_test_script)
		response = self.session.get(url)
		return xss_test_script in response.content.decode()

# scans & tells if a link or a form in  a link is vuln 
	def run_scanner(self):
		for link in self.list_links:
			forms = self.extract_html(link)
			#print("[ * ] {} Forms detected in this link: {}\n" .format(len(forms),link))
			for form in forms:
				print(colored("[ + ] Testing form in: {}" .format(link),'red'))
				can_be_xssed = self.test_xss_form(form,link)
				if can_be_xssed:
					print (colored("\n\n\n[_BOOM_] XSS vulnerability found in: \t\""+link+"\"\t<<< in the form:\n\n",'green')+colored(form.decode()+"\n\n\n",'blue'))
			if "=" in link:
				print(colored("[ + ] Testing: {}" .format(link),'red'))
				can_be_xssed = self.test_xss_link(link)
				if can_be_xssed:
					print(colored("\n\n\n\n[_BOOM_] XSS vulnerability found in: \t"+link+"\t <<< click or browse this link\n\n\n",'green'))





